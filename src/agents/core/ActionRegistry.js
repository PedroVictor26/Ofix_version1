/**
 * üóÇÔ∏è ACTION REGISTRY
 * 
 * Registro central de todas as a√ß√µes que o agente pode executar
 * Gerencia capacidades, permiss√µes e execu√ß√£o de a√ß√µes
 */

import { ServiceActions } from '../actions/ServiceActions.js';
import { ClientActions } from '../actions/ClientActions.js';
import { ScheduleActions } from '../actions/ScheduleActions.js';
import { NotificationActions } from '../actions/NotificationActions.js';

class ActionRegistry {
  constructor() {
    this.actions = new Map();
    this.skills = new Map();
    this.integrations = new Map();
    this.isInitialized = false;
  }

  /**
   * Inicializar registro com todas as a√ß√µes dispon√≠veis
   */
  async initialize() {
    console.log('üóÇÔ∏è Inicializando Action Registry...');
    
    try {
      // Registrar a√ß√µes de servi√ßos
      await this.registerServiceActions();
      
      // Registrar a√ß√µes de clientes
      await this.registerClientActions();
      
      // Registrar a√ß√µes de agendamento
      await this.registerScheduleActions();
      
      // Registrar a√ß√µes de notifica√ß√£o
      await this.registerNotificationActions();
      
      // Registrar skills especializadas
      await this.registerSkills();
      
      this.isInitialized = true;
      console.log(`‚úÖ Action Registry inicializado com ${this.actions.size} a√ß√µes`);
      
    } catch (error) {
      console.error('‚ùå Erro ao inicializar Action Registry:', error);
      throw error;
    }
  }

  /**
   * Registrar uma a√ß√£o no sistema
   */
  registerAction(actionType, actionConfig) {
    console.log(`üìù Registrando a√ß√£o: ${actionType}`);
    
    // Validar configura√ß√£o da a√ß√£o
    if (!actionConfig.execute || typeof actionConfig.execute !== 'function') {
      throw new Error(`A√ß√£o ${actionType} deve ter um m√©todo execute`);
    }
    
    const action = {
      type: actionType,
      description: actionConfig.description || actionType,
      category: actionConfig.category || 'general',
      requiredParams: actionConfig.requiredParams || [],
      optionalParams: actionConfig.optionalParams || [],
      requiresAuth: actionConfig.requiresAuth || false,
      permissions: actionConfig.permissions || [],
      execute: actionConfig.execute,
      examples: actionConfig.examples || [],
      keywords: actionConfig.keywords || [],
      confidence: actionConfig.confidence || 1.0
    };
    
    this.actions.set(actionType, action);
  }

  /**
   * Obter uma a√ß√£o espec√≠fica
   */
  getAction(actionType) {
    return this.actions.get(actionType);
  }

  /**
   * Buscar a√ß√µes por palavras-chave
   */
  findActionsByKeywords(keywords) {
    const results = [];
    
    for (const [actionType, action] of this.actions) {
      const score = this.calculateKeywordMatch(keywords, action.keywords);
      if (score > 0) {
        results.push({
          action: actionType,
          config: action,
          score
        });
      }
    }
    
    // Ordenar por relev√¢ncia
    results.sort((a, b) => b.score - a.score);
    
    return results;
  }

  /**
   * Calcular correspond√™ncia de palavras-chave
   */
  calculateKeywordMatch(inputKeywords, actionKeywords) {
    if (!inputKeywords || !actionKeywords) return 0;
    
    let matches = 0;
    const normalizedInput = inputKeywords.map(k => k.toLowerCase());
    const normalizedAction = actionKeywords.map(k => k.toLowerCase());
    
    for (const keyword of normalizedInput) {
      for (const actionKeyword of normalizedAction) {
        if (keyword.includes(actionKeyword) || actionKeyword.includes(keyword)) {
          matches++;
        }
      }
    }
    
    return matches / Math.max(normalizedInput.length, normalizedAction.length);
  }

  /**
   * Registrar a√ß√µes de servi√ßos
   */
  async registerServiceActions() {
    const serviceActions = new ServiceActions();
    
    // Criar ordem de servi√ßo
    this.registerAction('service.create', {
      description: 'Criar nova ordem de servi√ßo',
      category: 'service',
      requiredParams: ['descricaoProblema'],
      optionalParams: ['clienteId', 'veiculoId', 'dataPrevisaoEntrega', 'valorTotalEstimado', 'clienteNome', 'clienteTelefone', 'veiculoDescricao'],
      requiresAuth: true,
      permissions: ['service.create'],
      keywords: ['criar', 'ordem', 'servi√ßo', 'os', 'abertura'],
      execute: serviceActions.createOrder.bind(serviceActions),
      examples: [
        'Criar ordem de servi√ßo para problema no motor',
        'Abrir OS para manuten√ß√£o preventiva'
      ]
    });
    
    // Atualizar status do servi√ßo
    this.registerAction('service.updateStatus', {
      description: 'Atualizar status de uma ordem de servi√ßo',
      category: 'service',
      requiredParams: ['servicoId', 'novoStatus'],
      requiresAuth: true,
      permissions: ['service.update'],
      keywords: ['atualizar', 'status', 'ordem', 'servi√ßo'],
      execute: serviceActions.updateStatus.bind(serviceActions),
      examples: [
        'Marcar servi√ßo como em andamento',
        'Finalizar ordem de servi√ßo'
      ]
    });
    
    // Buscar servi√ßos
    this.registerAction('service.search', {
      description: 'Buscar ordens de servi√ßo',
      category: 'service',
      requiredParams: ['query'],
      optionalParams: ['status', 'clienteId', 'dataInicio', 'dataFim'],
      requiresAuth: true,
      permissions: ['service.read'],
      keywords: ['buscar', 'encontrar', 'servi√ßo', 'ordem', 'consultar'],
      execute: serviceActions.search.bind(serviceActions),
      examples: [
        'Buscar servi√ßos do cliente Jo√£o',
        'Encontrar OS em andamento'
      ]
    });
  }

  /**
   * Registrar a√ß√µes de clientes
   */
  async registerClientActions() {
    const clientActions = new ClientActions();
    
    // Criar cliente
    this.registerAction('client.create', {
      description: 'Cadastrar novo cliente',
      category: 'client',
      requiredParams: ['nome', 'contato'],
      optionalParams: ['email', 'endereco', 'cpf'],
      requiresAuth: true,
      permissions: ['client.create'],
      keywords: ['cadastrar', 'cliente', 'novo', 'registrar'],
      execute: clientActions.create.bind(clientActions),
      examples: [
        'Cadastrar novo cliente Jo√£o Silva',
        'Registrar cliente com telefone 11999999999'
      ]
    });
    
    // Buscar cliente
    this.registerAction('client.search', {
      description: 'Buscar cliente por nome, telefone ou documento',
      category: 'client',
      requiredParams: ['query'],
      requiresAuth: false, // Busca b√°sica pode ser p√∫blica
      keywords: ['buscar', 'cliente', 'encontrar', 'procurar'],
      execute: clientActions.search.bind(clientActions),
      examples: [
        'Buscar cliente Jo√£o',
        'Encontrar cliente pelo telefone 11999999999'
      ]
    });
    
    // Atualizar cliente
    this.registerAction('client.update', {
      description: 'Atualizar dados de um cliente',
      category: 'client',
      requiredParams: ['clienteId'],
      optionalParams: ['nome', 'contato', 'email', 'endereco'],
      requiresAuth: true,
      permissions: ['client.update'],
      keywords: ['atualizar', 'cliente', 'editar', 'modificar'],
      execute: clientActions.update.bind(clientActions),
      examples: [
        'Atualizar telefone do cliente',
        'Modificar endere√ßo do cliente'
      ]
    });
  }

  /**
   * Registrar a√ß√µes de agendamento
   */
  async registerScheduleActions() {
    const scheduleActions = new ScheduleActions();
    
    // Agendar servi√ßo
    this.registerAction('schedule.book', {
      description: 'Agendar um servi√ßo para data e hora espec√≠ficas',
      category: 'schedule',
      requiredParams: ['servicoTipo'],
      optionalParams: ['clienteId', 'dataHora', 'data', 'hora', 'observacoes', 'prioridade', 'clienteNome', 'clienteTelefone'],
      requiresAuth: true,
      permissions: ['schedule.create'],
      keywords: ['agendar', 'marcar', 'hor√°rio', 'data', 'compromisso'],
      execute: scheduleActions.book.bind(scheduleActions),
      examples: [
        'Agendar revis√£o para amanh√£ √†s 14h',
        'Marcar diagn√≥stico para sexta-feira'
      ]
    });
    
    // Verificar disponibilidade
    this.registerAction('schedule.checkAvailability', {
      description: 'Verificar hor√°rios dispon√≠veis',
      category: 'schedule',
      requiredParams: ['data'],
      optionalParams: ['periodo', 'tipoServico'],
      requiresAuth: false,
      keywords: ['disponibilidade', 'hor√°rio', 'livre', 'vago'],
      execute: scheduleActions.checkAvailability.bind(scheduleActions),
      examples: [
        'Verificar disponibilidade para amanh√£',
        'Que hor√°rios est√£o livres na sexta?'
      ]
    });
  }

  /**
   * Registrar a√ß√µes de notifica√ß√£o
   */
  async registerNotificationActions() {
    const notificationActions = new NotificationActions();
    
    // Enviar notifica√ß√£o
    this.registerAction('notification.send', {
      description: 'Enviar notifica√ß√£o para cliente ou funcion√°rio',
      category: 'notification',
      requiredParams: ['destinatario', 'mensagem'],
      optionalParams: ['tipo', 'prioridade', 'canal'],
      requiresAuth: true,
      permissions: ['notification.send'],
      keywords: ['notificar', 'avisar', 'comunicar', 'informar'],
      execute: notificationActions.send.bind(notificationActions),
      examples: [
        'Avisar cliente que servi√ßo est√° pronto',
        'Notificar equipe sobre urg√™ncia'
      ]
    });
    
    // Enviar WhatsApp
    this.registerAction('whatsapp.send', {
      description: 'Enviar mensagem via WhatsApp',
      category: 'notification',
      requiredParams: ['telefone', 'mensagem'],
      requiresAuth: true,
      permissions: ['whatsapp.send'],
      keywords: ['whatsapp', 'wpp', 'zap', 'mensagem'],
      execute: notificationActions.sendWhatsApp.bind(notificationActions),
      examples: [
        'Enviar confirma√ß√£o por WhatsApp',
        'Mandar lembrete via zap'
      ]
    });
  }

  /**
   * Registrar skills especializadas
   */
  async registerSkills() {
    // TODO: Implementar skills espec√≠ficas
    console.log('üìö Skills especializadas ser√£o implementadas na Fase 2');
  }

  /**
   * Obter todas as a√ß√µes dispon√≠veis
   */
  getAvailableActions() {
    return Array.from(this.actions.entries()).map(([type, config]) => ({
      type,
      description: config.description,
      category: config.category,
      requiresAuth: config.requiresAuth,
      keywords: config.keywords
    }));
  }

  /**
   * Obter a√ß√µes por categoria
   */
  getActionsByCategory(category) {
    const categoryActions = [];
    
    for (const [type, config] of this.actions) {
      if (config.category === category) {
        categoryActions.push({ type, ...config });
      }
    }
    
    return categoryActions;
  }

  /**
   * Verificar se a√ß√£o existe
   */
  hasAction(actionType) {
    return this.actions.has(actionType);
  }

  /**
   * Obter skills dispon√≠veis
   */
  getAvailableSkills() {
    return Array.from(this.skills.keys());
  }

  /**
   * Obter integra√ß√µes dispon√≠veis
   */
  getAvailableIntegrations() {
    return Array.from(this.integrations.keys());
  }

  /**
   * Health check do registry
   */
  async healthCheck() {
    return this.isInitialized && this.actions.size > 0;
  }
}

export { ActionRegistry };
