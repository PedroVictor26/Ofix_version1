import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

/**
 * Dados de exemplo para popular a base de conhecimento do assistente virtual
 */
const knowledgeBaseData = [
  // Problemas de Motor
  {
    title: "Motor falhando - An√°lise geral",
    content: "Motor falhando pode indicar diversos problemas. Principais causas: sistema de igni√ß√£o defeituoso, problemas no sistema de combust√≠vel, filtros entupidos, velas de igni√ß√£o gastas, bobinas de igni√ß√£o com defeito. Diagn√≥stico deve come√ßar pela leitura de c√≥digos de erro via scanner. Verificar press√£o de combust√≠vel, funcionamento das velas e bobinas. Teste de compress√£o pode ser necess√°rio.",
    category: "diagnostic",
    tags: ["motor", "falha", "igni√ß√£o", "combust√≠vel"],
    vehicleBrands: ["Ford", "Volkswagen", "Chevrolet", "Fiat", "Toyota", "Honda"],
    vehicleModels: ["Fiesta", "Gol", "Onix", "Uno", "Corolla", "Civic"],
    symptoms: ["motor falhando", "perda de pot√™ncia", "motor irregular", "acelera√ß√£o ruim"],
    solutions: [
      "Verificar velas de igni√ß√£o",
      "Testar bobinas de igni√ß√£o", 
      "Limpar bicos injetores",
      "Trocar filtro de combust√≠vel",
      "Verificar press√£o de combust√≠vel"
    ],
    difficulty: "medium",
    estimatedTime: 60,
    estimatedCost: 200.00
  },
  
  {
    title: "Fuma√ßa azul no escapamento",
    content: "Fuma√ßa azul indica queima de √≥leo no motor. Principais causas: an√©is de pist√£o desgastados, v√°lvulas ou guias de v√°lvulas gastas, turbo defeituoso (se equipado). Verificar n√≠vel de √≥leo constantemente. Pode ser necess√°rio ret√≠fica do motor em casos severos. Teste de compress√£o e vazamento interno s√£o essenciais para diagn√≥stico preciso.",
    category: "diagnostic", 
    tags: ["motor", "√≥leo", "fuma√ßa", "pist√£o", "v√°lvulas"],
    vehicleBrands: ["Ford", "Volkswagen", "Chevrolet", "Fiat"],
    vehicleModels: [],
    symptoms: ["fuma√ßa azul", "consumo de √≥leo", "√≥leo queimando"],
    solutions: [
      "Teste de compress√£o",
      "Verificar guias de v√°lvulas",
      "Avaliar necessidade de ret√≠fica",
      "Trocar an√©is de pist√£o",
      "Verificar turbo (se equipado)"
    ],
    difficulty: "hard",
    estimatedTime: 180,
    estimatedCost: 2500.00
  },

  {
    title: "Superaquecimento do motor",
    content: "Superaquecimento pode causar danos severos ao motor. Principais causas: vazamento no sistema de arrefecimento, termostato defeituoso, radiador entupido, bomba d'√°gua com problemas, ventilador n√£o funcionando, junta do cabe√ßote queimada. Nunca abrir radiador quente. Verificar n√≠vel de √°gua, estado das mangueiras e funcionamento do ventilador.",
    category: "diagnostic",
    tags: ["motor", "superaquecimento", "radiador", "termostato"],
    vehicleBrands: ["Ford", "Volkswagen", "Chevrolet", "Fiat", "Toyota", "Honda", "Nissan"],
    vehicleModels: [],
    symptoms: ["motor quente", "temperatura alta", "vapor", "fervendo"],
    solutions: [
      "Verificar n√≠vel de √°gua",
      "Testar termostato",
      "Limpar radiador", 
      "Verificar bomba d'√°gua",
      "Testar ventilador",
      "Verificar junta do cabe√ßote"
    ],
    difficulty: "medium",
    estimatedTime: 90,
    estimatedCost: 300.00
  },

  // Problemas de Freios
  {
    title: "Ru√≠do nos freios - Diagn√≥stico",
    content: "Ru√≠dos nos freios podem indicar desgaste das pastilhas, discos empenados, falta de lubrifica√ß√£o ou contamina√ß√£o. Ru√≠do agudo (guincho) geralmente indica pastilhas gastas. Vibra√ß√£o pode indicar discos empenados. Sempre verificar espessura das pastilhas e estado dos discos. Sistema de freios √© item de seguran√ßa cr√≠tica.",
    category: "diagnostic",
    tags: ["freios", "pastilhas", "discos", "seguran√ßa"],
    vehicleBrands: ["Ford", "Volkswagen", "Chevrolet", "Fiat", "Toyota", "Honda"],
    vehicleModels: [],
    symptoms: ["ru√≠do nos freios", "guincho", "freio duro", "vibra√ß√£o no freio"],
    solutions: [
      "Verificar pastilhas de freio",
      "Medir espessura dos discos", 
      "Lubrificar guias de pin√ßa",
      "Verificar fluido de freio",
      "Retificar ou trocar discos"
    ],
    difficulty: "easy",
    estimatedTime: 45,
    estimatedCost: 180.00
  },

  // Problemas El√©tricos
  {
    title: "Bateria descarregando rapidamente",
    content: "Descarga r√°pida da bateria pode indicar alternador defeituoso, fuga de corrente ou bateria no fim da vida √∫til. Verificar tens√£o de carga (13.8V a 14.4V com motor ligado). Teste de fuga de corrente com amper√≠metro. Verificar estado dos terminais e cabos. Bateria com mais de 3 anos pode precisar substitui√ß√£o.",
    category: "diagnostic",
    tags: ["bateria", "alternador", "el√©trico", "carga"],
    vehicleBrands: ["Ford", "Volkswagen", "Chevrolet", "Fiat", "Toyota", "Honda"],
    vehicleModels: [],
    symptoms: ["bateria fraca", "n√£o liga", "luzes fracas", "alternador"],
    solutions: [
      "Testar tens√£o do alternador",
      "Verificar correia do alternador",
      "Teste de fuga de corrente",
      "Limpar terminais da bateria",
      "Substituir bateria se necess√°rio"
    ],
    difficulty: "easy",
    estimatedTime: 30,
    estimatedCost: 400.00
  },

  // Manuten√ß√£o Preventiva
  {
    title: "Troca de √≥leo - Procedimento completo",
    content: "Troca de √≥leo √© manuten√ß√£o essencial. Intervalo varia conforme fabricante (5.000 a 10.000 km). Sempre trocar filtro junto com √≥leo. Verificar especifica√ß√£o do √≥leo (viscosidade). Aquecer motor antes da troca. Verificar n√≠vel ap√≥s troca e funcionamento. Descartar √≥leo usado em local apropriado.",
    category: "maintenance",
    tags: ["√≥leo", "filtro", "manuten√ß√£o", "preventiva"],
    vehicleBrands: ["Ford", "Volkswagen", "Chevrolet", "Fiat", "Toyota", "Honda"],
    vehicleModels: [],
    symptoms: ["manuten√ß√£o", "troca de √≥leo", "revis√£o"],
    solutions: [
      "Drenar √≥leo usado",
      "Trocar filtro de √≥leo",
      "Adicionar √≥leo novo",
      "Verificar n√≠vel",
      "Testar funcionamento"
    ],
    difficulty: "easy",
    estimatedTime: 20,
    estimatedCost: 80.00
  },

  {
    title: "Revis√£o dos 10.000 km",
    content: "Revis√£o importante para manter garantia e desempenho. Inclui: troca de √≥leo e filtros, verifica√ß√£o de n√≠veis, inspe√ß√£o de correias, teste de bateria, verifica√ß√£o de freios, alinhamento e balanceamento se necess√°rio. Consultar manual do propriet√°rio para itens espec√≠ficos do modelo.",
    category: "maintenance",
    tags: ["revis√£o", "manuten√ß√£o", "10000km", "preventiva"],
    vehicleBrands: ["Ford", "Volkswagen", "Chevrolet", "Fiat", "Toyota", "Honda"],
    vehicleModels: [],
    symptoms: ["revis√£o", "manuten√ß√£o preventiva", "10000"],
    solutions: [
      "Troca de √≥leo e filtros",
      "Verificar n√≠veis",
      "Inspe√ß√£o visual geral",
      "Teste de sistemas",
      "Atualizar registro de manuten√ß√£o"
    ],
    difficulty: "medium",
    estimatedTime: 120,
    estimatedCost: 350.00
  },

  // Ar Condicionado
  {
    title: "Ar condicionado n√£o gela",
    content: "Ar condicionado sem efici√™ncia pode indicar g√°s insuficiente, compressor defeituoso, filtro sujo ou condensador entupido. Verificar press√£o do sistema, funcionamento do compressor e estado do filtro de cabine. Limpeza do condensador pode melhorar efici√™ncia. Vazamentos devem ser localizados e reparados.",
    category: "diagnostic",
    tags: ["ar condicionado", "refrigera√ß√£o", "compressor", "g√°s"],
    vehicleBrands: ["Ford", "Volkswagen", "Chevrolet", "Fiat", "Toyota", "Honda"],
    vehicleModels: [],
    symptoms: ["ar condicionado fraco", "n√£o gela", "compressor n√£o funciona"],
    solutions: [
      "Verificar press√£o do g√°s",
      "Testar compressor",
      "Trocar filtro de cabine",
      "Limpar condensador",
      "Localizar vazamentos"
    ],
    difficulty: "medium",
    estimatedTime: 90,
    estimatedCost: 250.00
  },

  // Suspens√£o
  {
    title: "Barulho na suspens√£o",
    content: "Ru√≠dos na suspens√£o podem indicar amortecedores gastos, buchas desgastadas, molas quebradas ou terminais de dire√ß√£o com folga. Barulho de 'toc toc' geralmente indica buchas. Teste dirigindo em lombadas e curvas. Inspe√ß√£o visual e teste manual necess√°rios para diagn√≥stico preciso.",
    category: "diagnostic",
    tags: ["suspens√£o", "amortecedor", "buchas", "molas"],
    vehicleBrands: ["Ford", "Volkswagen", "Chevrolet", "Fiat"],
    vehicleModels: [],
    symptoms: ["barulho suspens√£o", "toc toc", "carro balan√ßando"],
    solutions: [
      "Verificar amortecedores",
      "Inspecionar buchas",
      "Verificar molas",
      "Testar terminais de dire√ß√£o",
      "Lubrificar se necess√°rio"
    ],
    difficulty: "medium",
    estimatedTime: 60,
    estimatedCost: 200.00
  },

  // Transmiss√£o
  {
    title: "Embreagem patinando",
    content: "Embreagem patinando indica disco desgastado, plat√¥ com problemas ou sistema hidr√°ulico com defeito. Sintomas: RPM sobe mas velocidade n√£o acompanha, dificuldade em subir ladeiras, cheiro de queimado. Verificar n√≠vel do fluido da embreagem. Pode necessitar troca completa do kit.",
    category: "diagnostic",
    tags: ["embreagem", "transmiss√£o", "disco", "plat√¥"],
    vehicleBrands: ["Ford", "Volkswagen", "Chevrolet", "Fiat"],
    vehicleModels: [],
    symptoms: ["embreagem patinando", "RPM alto", "cheiro queimado"],
    solutions: [
      "Verificar fluido da embreagem",
      "Testar curso do pedal",
      "Avaliar kit de embreagem",
      "Verificar volante",
      "Substituir se necess√°rio"
    ],
    difficulty: "hard",
    estimatedTime: 240,
    estimatedCost: 800.00
  }
];

/**
 * Fun√ß√£o para popular a base de conhecimento
 */
export async function seedKnowledgeBase() {
  try {
    console.log('üå± Iniciando popula√ß√£o da base de conhecimento...');

    // Limpar dados existentes (opcional)
    await prisma.knowledgeBase.deleteMany();
    console.log('üóëÔ∏è Dados antigos removidos');

    // Inserir novos dados
    for (const item of knowledgeBaseData) {
      await prisma.knowledgeBase.create({
        data: {
          ...item,
          popularity: Math.floor(Math.random() * 50), // Popularidade aleat√≥ria inicial
          lastUsed: new Date()
        }
      });
    }

    console.log(`‚úÖ ${knowledgeBaseData.length} itens adicionados √† base de conhecimento`);

    // Verificar dados inseridos
    const count = await prisma.knowledgeBase.count();
    console.log(`üìä Total de itens na base: ${count}`);

    return { success: true, count };

  } catch (error) {
    console.error('‚ùå Erro ao popular base de conhecimento:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

/**
 * Fun√ß√£o para adicionar templates de prompt
 */
export async function seedPromptTemplates() {
  const templates = [
    {
      name: 'cliente_base',
      description: 'Template base para atendimento ao cliente',
      template: `Voc√™ √© um assistente virtual especializado em atendimento ao cliente de oficinas mec√¢nicas.

CARACTER√çSTICAS:
- Seja cordial, prestativo e profissional
- Use linguagem clara e acess√≠vel
- Forne√ßa informa√ß√µes precisas sobre servi√ßos
- Sempre ofere√ßa pr√≥ximos passos claros
- Mantenha foco em resolver problemas do cliente

CONTEXTO DA CONVERSA:
{{conversationHistory}}

INFORMA√á√ïES DO VE√çCULO:
{{vehicleInfo}}

INSTRU√á√ïES:
- Responda sempre em portugu√™s brasileiro
- Se n√£o souber algo, seja honesto e ofere√ßa alternativas
- Para consultas de status, pe√ßa placa ou n√∫mero da OS
- Para agendamentos, colete informa√ß√µes necess√°rias`,
      variables: ['conversationHistory', 'vehicleInfo'],
      category: 'customer',
      isActive: true
    },

    {
      name: 'mecanico_diagnostic',
      description: 'Template para diagn√≥sticos t√©cnicos',
      template: `Voc√™ √© um assistente t√©cnico especializado para mec√¢nicos automotivos.

CARACTER√çSTICAS:
- Use terminologia t√©cnica apropriada
- Forne√ßa diagn√≥sticos baseados em sintomas
- Sugira procedimentos espec√≠ficos
- Inclua informa√ß√µes de seguran√ßa
- Seja preciso e detalhado

BASE DE CONHECIMENTO:
{{knowledgeResults}}

SINTOMAS RELATADOS:
{{symptoms}}

INFORMA√á√ïES DO VE√çCULO:
{{vehicleInfo}}

INSTRU√á√ïES:
- Priorize seguran√ßa em todos os procedimentos
- Forne√ßa estimativas realistas de tempo e custo
- Sugira ferramentas necess√°rias
- Inclua c√≥digos de pe√ßa quando relevante`,
      variables: ['knowledgeResults', 'symptoms', 'vehicleInfo'],
      category: 'diagnostic',
      isActive: true
    },

    {
      name: 'admin_analytics',
      description: 'Template para relat√≥rios administrativos',
      template: `Voc√™ √© um assistente administrativo para gestores de oficinas.

CARACTER√çSTICAS:
- Forne√ßa informa√ß√µes anal√≠ticas
- Use dados e m√©tricas
- Seja objetivo e direto
- Foque em efici√™ncia operacional

DADOS DISPON√çVEIS:
{{analyticsData}}

INSTRU√á√ïES:
- Apresente dados de forma clara
- Identifique tend√™ncias importantes
- Sugira a√ß√µes baseadas nos dados
- Use gr√°ficos conceituais quando apropriado`,
      variables: ['analyticsData'],
      category: 'admin',
      isActive: true
    }
  ];

  try {
    console.log('üå± Criando templates de prompt...');

    for (const template of templates) {
      await prisma.promptTemplate.upsert({
        where: { name: template.name },
        update: template,
        create: template
      });
    }

    console.log(`‚úÖ ${templates.length} templates criados`);
    return { success: true, count: templates.length };

  } catch (error) {
    console.error('‚ùå Erro ao criar templates:', error);
    throw error;
  }
}

// Executar se chamado diretamente
if (import.meta.url === `file://${process.argv[1]}`) {
  Promise.all([
    seedKnowledgeBase(),
    seedPromptTemplates()
  ]).then(() => {
    console.log('üéâ Seed completo!');
    process.exit(0);
  }).catch((error) => {
    console.error('üí• Erro no seed:', error);
    process.exit(1);
  });
}

export default { seedKnowledgeBase, seedPromptTemplates };
